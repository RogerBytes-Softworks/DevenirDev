<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>PHP - La manipulation de fichiers</title>

  <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/github-markdown.css" />
  <link rel="stylesheet" href="assets/css/menu-markdown.css" />
  <link rel="stylesheet" href="assets/css/stackoverflow-dark.min.css" />
  <link rel="stylesheet" href="assets/css/navbar.css" />

  <script src="assets/js/jquery-3.4.1.min.js" defer></script>
  <script src="assets/js/popper.min.js" defer></script>
  <script src="assets/js/bootstrap.min.js" defer></script>

  <script src="assets/js/highlight.min.js" defer></script>

  <style>
    .note-pedago {
      border-left: 4px solid rgba(255, 255, 255, .35);
      padding: .85rem 1rem;
      margin: 1rem 0;
      background: rgba(255, 255, 255, .04);
      border-radius: 10px;
    }

    .note-pedago code {
      white-space: normal;
    }

    .note-pedago p {
      margin: 0.25rem 0;
    }

    .note-pedago ul {
      margin: 0.4rem 0 0.4rem 1.1rem;
    }
  </style>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.hljs) hljs.highlightAll();
      const h1 = document.querySelector("h1");
      if (h1) document.title = h1.textContent.trim();
    });
  </script>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top py-0" id="jsnav">
        <div class="container">
            <a class="navbar-brand py-0 my-0" href="PHP_01_Les_bases.html" style="font-size: 14px">PHP Cours</a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#jsNavbar"
                aria-controls="jsNavbar" aria-expanded="false" aria-label="Menu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="jsNavbar">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle py-1" href="#" id="chaptersDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Chapitres
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="chaptersDropdown">
                            <a class="dropdown-item" href="PHP_01_Les_bases.html">
                                PHP_01_Les_bases
                            </a>
                            <a class="dropdown-item" href="PHP_02_Les_instructions_conditionnelles.html">
                                PHP_02_Les_instructions_conditionnelles
                            </a>
                            <a class="dropdown-item" href="PHP_03_Les_tableaux.html">
                                PHP_03_Les_tableaux
                            </a>
                            <a class="dropdown-item" href="PHP_04_Les_fonctions.html">
                                PHP_04_Les_fonctions
                            </a>
                            <a class="dropdown-item" href="PHP_05_Les_dates_et_les_heures.html">
                                PHP_05_Les_dates_et_les_heures
                            </a>
                            <a class="dropdown-item" href="PHP_06_Les_formulaires_et_les_variables_serveur.html">
                                PHP_06_Les_formulaires_et_les_variables_serveur
                            </a>
                            <a class="dropdown-item" href="PHP_07_La_manipulation_de_fichiers.html">
                                PHP_07_La_manipulation_de_fichiers
                            </a>
                            <a class="dropdown-item" href="PHP_08_Le_telechargement_de_fichiers.html">
                                PHP_08_Le_telechargement_de_fichiers
                            </a>
                            <a class="dropdown-item" href="PHP_09_Les_bibliotheques_de_fonctions.html">
                                PHP_09_Les_bibliotheques_de_fonctions
                            </a>
                            <a class="dropdown-item" href="PHP_10_PDO_Prise_en_main.html">
                                PHP_10_PDO_Prise_en_main
                            </a>
                            <a class="dropdown-item" href="PHP_11_PDO_CRUD_Create.html">
                                PHP_11_PDO_CRUD_Create
                            </a>
                            <a class="dropdown-item" href="PHP_12_PDO_CRUD_Read.html">
                                PHP_12_PDO_CRUD_Read
                            </a>
                            <a class="dropdown-item" href="PHP_13_PDO_CRUD_Update.html">
                                PHP_13_PDO_CRUD_Update
                            </a>
                            <a class="dropdown-item" href="PHP_14_PDO_CRUD_Delete.html">
                                PHP_14_PDO_CRUD_Delete
                            </a>
                            <a class="dropdown-item" href="PHP_15_Les_injections_SQL.html">
                                PHP_15_Les_injections_SQL
                            </a>
                            <a class="dropdown-item" href="PHP_16_PDO_Les_requetes_preparees.html">
                                PHP_16_PDO_Les_requêtes_préparées
                            </a>
                            <a class="dropdown-item" href="PHP_17_PDO_Synthese.html">
                                PHP_17_PDO_Synthese
                            </a>
                            <a class="dropdown-item" href="PHP_18_Les_sessions.html">
                                PHP_18_Les_sessions
                            </a>
                            <a class="dropdown-item" href="PHP_19_Authentification_et_mots_de_passe.html">
                                PHP_19_Authentification_et_mots_de_passe
                            </a>
                            <a class="dropdown-item" href="PHP_20_Les_mails.html">
                                PHP_20_Les_mails
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

  <main class="container">
    <article class="markdown-body">
      <h1 id="1">PHP - La manipulation de fichiers</h1>

      <p><br /><br /></p>

      <p>
        Avant d'aborder un exemple de manipulation de fichiers en PHP nous allons voir les différentes façons d'ouvrir
        un fichier.
      </p>

      <h2 id="4">Ouverture d'un fichier</h2>
      <ul>
        <li>Ouverture en lecture seulement depuis le début du fichier ("r") :
          <code>$fp = fopen(string fichier, "r");</code>
        </li>
        <li>Ouverture en écriture seulement depuis le début du fichier ("w") :
          <code>$fp = fopen(string fichier, "w");</code>
        </li>
        <li>Ouverture en écriture seulement depuis la fin du fichier ("a") :
          <code>$fp = fopen(string fichier, "a");</code>
        </li>
      </ul>

      <p>Exemples :</p>

      <pre><code class="language-php hljs">$fp = fopen("/home/rasmus/file.txt", "r");
$fp = fopen("../exemple.txt", "a");
$fp = fopen("http://www.php.net/", "r");
$fp = fopen("ftp://user:password@example.com/", "w");</code></pre>

      <div class="note-pedago">
        <p><strong>Point technique</strong> : ouvrir une URL avec <code>fopen("http://...")</code> dépend de la
          configuration PHP (<code>allow_url_fopen</code>).
          Sur beaucoup d'hébergements, c'est désactivé pour des raisons de sécurité. Dans ce cas, on passera par cURL.
        </p>
        <p><strong>Astuce</strong> : pour éviter des chemins relatifs fragiles, on construit les chemins en partant de
          <code>__DIR__</code> :
        </p>
        <pre><code class="language-php hljs">$fp = fopen(__DIR__ . "/essai.txt", "a");</code></pre>
      </div>

      <p>
        Il faut garder à l'esprit que l'on définit ici les fichiers au sens général du terme,
        vous pouvez donc grâce à ces instructions manipuler des fichiers <em>html</em>, <em>txt</em>, <em>php</em> etc.
      </p>

      <blockquote>
        <p><code>$fp</code> étant une variable, son nommage est bien entendu libre; il s'agit ici de la convention
          adoptée dans la documentation officielle PHP.</p>
      </blockquote>

      <h2 id="10">Les instructions principales</h2>

      <h3 id="11">Ecriture dans un fichier</h3>
      <p>
        La fonction <code>fputs()</code> permet <strong>d'écrire</strong> dans un fichier; elle reçoit 2 arguments
        obligatoires et
        un troisième facultatif : <code>fputs($fp, $str, length);</code> :
      </p>

      <div class="note-pedago">
        <p><strong>Correction technique</strong> : le texte initial disait “permet de lire un fichier” pour
          <code>fputs()</code>.
          En réalité, <code>fputs()</code> (alias de <code>fwrite()</code>) sert à <strong>écrire</strong>. La lecture
          se fait avec <code>fgets()</code>, <code>fread()</code>, <code>file()</code>, etc.
        </p>
      </div>

      <ul>
        <li><code>$fp</code> : pointe sur la ressource de fichier ouvert par <code>fopen()</code></li>
        <li><code>$str</code> : représente la variable à enregistrer</li>
        <li><code>length</code> : 3<sup>ème</sup> argument, facultatif, qui représente la longueur à écrire</li>
      </ul>

      <p>Exemple</p>

      <pre><code class="language-php hljs">// On déclare une variable dont la valeur (contenu) sera écrite dans le fichier
$myVar = "Bonjour le monde";

// Ouverture en écriture seule (en fin de fichier)
$fp = fopen("essai.txt", "a");

// Ecriture du contenu ($myVar)
fputs($fp, $myVar);

// Fermeture du fichier
fclose($fp);</code></pre>

      <div class="note-pedago">
        <p><strong>Bon réflexe</strong> : vérifie l'ouverture du fichier avant d'écrire :</p>
        <pre><code class="language-php hljs">$fp = fopen("essai.txt", "a");
if ($fp === false) {
    die("Impossible d'ouvrir le fichier.");
}</code></pre>
      </div>

      <p>Ouvrez le fichier <em>essai.txt</em> et vérifiez que la phrase <em>Bonjour le monde</em> s'y trouve.</p>

      <h3 id="17">Lecture dans un fichier</h3>
      <p>
        La fonction <code>fgets()</code> permet de lire un fichier; elle reçoit 2 arguments :
        <code>fgets($fp, length);</code> :
      </p>
      <ul>
        <li><code>$fp</code> : pointe sur la ressource de fichier ouvert avec <code>fopen()</code></li>
        <li><code>length</code> : représente la longueur d'enregistrement à lire (en octets)</li>
      </ul>

      <p>Exemple :</p>

      <pre><code class="language-php hljs">// Ouverture en lecture seule
$fp = fopen("essai.txt", "r");

if ($fp === false) {
    die("Impossible d'ouvrir le fichier.");
}

// Boucle jusqu'à la fin du fichier
while (!feof($fp)) {
    // Lecture d'une ligne, le contenu de la ligne est affecté à la variable $ligne
    $ligne = fgets($fp, 4096);

    if ($ligne === false) {
        break; // fin ou erreur de lecture
    }

    echo htmlspecialchars($ligne, ENT_QUOTES, 'UTF-8') . "&lt;br&gt;";
}

fclose($fp);</code></pre>

      <div class="note-pedago">
        <p><strong>Correction pédagogique</strong> : dans un terminal ou un fichier texte, le saut de ligne est
          <code>\n</code>.
          Dans une page HTML, on utilise <code>&lt;br&gt;</code> ou, mieux, on affiche dans un <code>&lt;pre&gt;</code>
          si on veut garder la mise en forme.
        </p>
      </div>

      <p>
        En fait l'instruction <code>fgets()</code> lit la ligne jusqu'à ce qu'elle rencontre un caractère de retour à la
        ligne <code>\n</code>.
        Par sécurité il est préférable de lui indiquer de lire 4096 caractères pour qu'elle puisse lire une ligne
        entière.
        Pour lire l'ensemble d'un fichier, vous pouvez aussi utilisez la fonction <code>file()</code>.
      </p>

      <h2 id="23">Les autres fonctions de gestion de fichiers</h2>

      <h3 id="24">La fonction <code>basename()</code></h3>
      <p>Cette fonction retourne le nom d'un fichier dans une URL ou un chemin d'accès à un fichier</p>

      <p>Exemple :</p>

      <pre><code class="language-php hljs">$path = "/home/httpd/html/index.php";
$file = basename($path); // $file retourne "index.php"</code></pre>

      <h3 id="28">La fonction <code>copy()</code></h3>
      <p>Copie un fichier vers un autre :</p>

      <pre><code class="language-php hljs">$fichier = "toto.txt";
/* création d'un fichier toto.txt.bak */
copy($fichier, $fichier . '.bak');</code></pre>

      <h3 id="31">La fonction <code>dirname()</code></h3>
      <p>Retourne le répertoire (<em>directory</em>) dans lequel se trouve le fichier :</p>

      <pre><code class="language-php hljs">$path = "/etc/passwd";
$file = dirname($path); /* $file retourne "/etc" */</code></pre>

      <h3 id="34">La fonction <code>file()</code></h3>
      <p>
        Pour lire l'ensemble d'un fichier et le retourner dans un tableau, chaque ligne du tableau correspond à une
        ligne du fichier.
      </p>

      <div class="note-pedago">
        <p><strong>Point technique</strong> : <code>file()</code> charge tout en mémoire. OK pour des fichiers
          “raisonnables”, mais pas pour des gros logs.
          Pour les gros fichiers, préfère la lecture ligne par ligne avec <code>fgets()</code>.</p>
      </div>

      <h3 id="36">La fonction <code>file_exists()</code></h3>
      <p>Retourne <code>true</code> (vrai) si le fichier existe.</p>

      <h3 id="38">La fonction <code>is_dir()</code></h3>
      <p>Retourne <code>true</code> si le chemin existe et est un répertoire (<em>directory</em>).</p>

      <h3 id="40">La fonction <code>is_file()</code></h3>
      <p>Retourne <code>true</code> si le chemin existe et est un fichier “classique” (<em>regular file</em>).</p>

      <h2 id="42">Un compteur texte en PHP</h2>
      <p>Vous voulez avoir un compteur différent pour toutes les pages de votre site ?</p>
      <p>Voici un petit script en PHP qui fera l'affaire :</p>

      <pre><code class="language-php hljs">// On ouvre le fichier moncompteur.txt
$fichier = fopen("moncompteur.txt", "r+");

// on lit la première ligne du fichier, le résultat est stocké dans la variable $visiteurs
$visiteurs = fgets($fichier);

// on ajoute 1 au nombre de visiteurs
$visiteurs++;

// on se positionne au début du fichier
fseek($fichier, 0);

// on écrit le nouveau nombre dans le fichier
fputs($fichier, $visiteurs);

// on referme le fichier moncompteur.txt
fclose($fichier);

// on indique sur la page le nombre de visiteurs
echo "$visiteurs personnes sont passées par ici";</code></pre>

      <div class="note-pedago">
        <p><strong>Point technique important</strong> : ce compteur est pédagogique, mais en production il a 2 problèmes
          fréquents :</p>
        <ul>
          <li><strong>Concurrence</strong> : si 2 visiteurs arrivent en même temps, tu peux perdre une incrémentation.
          </li>
          <li><strong>Type</strong> : <code>fgets()</code> renvoie une chaîne, mieux vaut convertir en entier.</li>
        </ul>
        <p>On peut améliorer avec <code>flock()</code> (verrou fichier) :</p>
        <pre><code class="language-php hljs">$fp = fopen("moncompteur.txt", "c+");
if ($fp === false) { die("Erreur fichier"); }

flock($fp, LOCK_EX); // verrou exclusif
$contenu = stream_get_contents($fp);
$visiteurs = (int) trim($contenu);
$visiteurs++;

ftruncate($fp, 0);
rewind($fp);
fwrite($fp, (string) $visiteurs);

flock($fp, LOCK_UN);
fclose($fp);

echo $visiteurs . " personnes sont passées par ici";</code></pre>
      </div>

      <p><em>Quelques précisions et explications :</em></p>
      <ul>
        <li>
          Vous devez placer sur votre site un fichier <code>moncompteur.txt</code> avec juste le chiffre 0 dedans.
          Bien entendu si vous désirez que votre compteur démarre à 1254, vous pouvez le faire.
        </li>
        <li>
          La fonction <code>fopen()</code> permet d'ouvrir un fichier présent sur votre site.
          L'attribut <em>r+</em> permet de l'ouvrir en lecture et écriture.
        </li>
        <li>La fonction <code>fgets()</code> permet de lire la première ligne du fichier.</li>
        <li>
          <code>fseek()</code> permet de se repositionner au début du fichier. Ainsi, lorsque l'on réécrit le nouveau
          nombre de visiteurs,
          on est sûr d'effacer l'ancien.
        </li>
        <li><code>fputs()</code> permet de réécrire la variable incrémentée dans le fichier.</li>
        <li><code>fclose()</code> permet de refermer le fichier <em>moncompteur.txt</em> que l'on a ouvert au début du
          script.</li>
      </ul>

      <p>Voici une autre version plus concise.</p>

      <pre><code class="language-php hljs">$visiteurs = file_get_contents("moncompteur.txt");

$visiteurs++;

file_put_contents("moncompteur.txt", $visiteurs);

print("$visiteurs personnes sont passées par ici");</code></pre>

      <div class="note-pedago">
        <p><strong>Point technique</strong> : même remarque ici sur la concurrence. Tu peux ajouter un verrou en passant
          le flag <code>LOCK_EX</code> :</p>
        <pre><code class="language-php hljs">file_put_contents("moncompteur.txt", $visiteurs, LOCK_EX);</code></pre>
        <p>Et pense à forcer le type : <code>$visiteurs = (int) trim(file_get_contents(...));</code></p>
      </div>

      <h2 id="50">Exercices</h2>

      <h4 id="51">Lecture d'un fichier</h4>
      <p>
        Téléchargez
        <a target="_blank" rel="noopener noreferrer"
          href="assets/ressources/liens.txt">ce fichier</a>,
        qui contient une liste de sites indispensables à la compréhension du monde moderne.
      </p>
      <p>
        Écrire un programme qui lit ce fichier et qui construit une page web contenant une liste de liens hypertextes.
      </p>
      <blockquote>
        <p>Utilisez la fonction <code>file()</code> qui permet de lire directement un fichier et renvoie son contenu
          sous forme de tableau.</p>
      </blockquote>

      <div class="note-pedago">
        <p><strong>Point sécurité</strong> : quand tu affiches un lien issu d'un fichier, valide et échappe :</p>
        <ul>
          <li>échapper le texte avec <code>htmlspecialchars</code>,</li>
          <li>vérifier que l'URL commence par <code>http://</code> ou <code>https://</code>,</li>
          <li>ajouter <code>rel="noopener noreferrer"</code> si <code>target="_blank"</code>.</li>
        </ul>
      </div>

      <h4 id="55">Récupération d'un fichier distant</h4>
      <p>Un site partenaire met à votre disposition une liste des nouveaux utilisateurs inscrits.</p>
      <p>
        Cette liste est disponible à cette adresse :
        <a href="assets/ressources/customers.csv" target="_blank"
          rel="noopener noreferrer">customers.csv</a>.
      </p>

      <p>
        Il s'agit d'un fichier <code>CSV</code> où chaque ligne représente un nouvel utilisateur.
        Les différents champs sont <code>Surname</code>, <code>Firstname</code>, <code>Email</code>, <code>Phone</code>,
        <code>City</code>, <code>State</code>,
        ils sont séparés par une virgule <code>,</code>.
      </p>

      <ol>
        <li>
          <p>Utilisez la fonction <code>file()</code> pour récupérer le contenu de ce fichier.</p>
        </li>
        <li>
          <p>Découpez chaque ligne en utilisant une des fonctions suivantes : <code>explode()</code> ou
            <code>preg_split()</code>
          </p>
        </li>
        <li>
          <p>Affichez le résultat dans un tableau HTML (avec Bootstrap si possible) en prenant bien soin de nommer les
            colonnes du tableau.</p>
        </li>
      </ol>

      <div class="note-pedago">
        <p><strong>Bon réflexe</strong> : pour lire du CSV, PHP propose aussi <code>fgetcsv()</code> (plus robuste que
          <code>explode()</code> si les champs contiennent des virgules).
        </p>
        <pre><code class="language-php hljs">$fp = fopen("customers.csv", "r");
$header = fgetcsv($fp); // première ligne (colonnes)
while (($row = fgetcsv($fp)) !== false) {
    // $row est un tableau de champs
}
fclose($fp);</code></pre>
      </div>

      <p><br /><br /><br /></p>
    </article>
  </main>
</body>

</html>