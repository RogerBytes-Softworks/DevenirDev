<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Les injections SQL</title>

  <link rel="stylesheet" href="assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/github-markdown.css">
  <link rel="stylesheet" href="assets/css/stackoverflow-dark.min.css">
  <link rel="stylesheet" href="assets/css/navbar.css">

  <style>
    body { padding-top: 56px; }
    .spacer { height: 1.5rem; }
    .skip-link {
      position: absolute; left: -999px; top: 0;
      background: #000; color: #fff; padding: .5rem .75rem; z-index: 2000;
    }
    .skip-link:focus { left: .5rem; top: .5rem; }

    .callout { border-left: 4px solid currentColor; padding: .75rem 1rem; margin: 1rem 0; border-radius: .25rem; }
    .callout-info { color: #0dcaf0; background: rgba(13, 202, 240, .08); }
    .callout-warn { color: #ffc107; background: rgba(255, 193, 7, .10); }
    .callout-danger { color: #dc3545; background: rgba(220, 53, 69, .10); }
    .callout strong { color: inherit; }

  </style>

  <script src="assets/js/jquery-3.4.1.min.js" defer></script>
  <script src="assets/js/popper.min.js" defer></script>
  <script src="assets/js/bootstrap.min.js" defer></script>
  <script src="assets/js/highlight.min.js" defer></script>
</head>

<body>
  <a class="skip-link" href="#contenu">Aller au contenu</a>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top py-0" id="jsnav">
        <div class="container">
            <a class="navbar-brand py-0 my-0" href="PHP_01_Les_bases.html" style="font-size: 14px">PHP Cours</a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#jsNavbar"
                aria-controls="jsNavbar" aria-expanded="false" aria-label="Menu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="jsNavbar">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle py-1" href="#" id="chaptersDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Chapitres
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="chaptersDropdown">
                            <a class="dropdown-item" href="PHP_01_Les_bases.html">
                                PHP_01_Les_bases
                            </a>
                            <a class="dropdown-item" href="PHP_02_Les_instructions_conditionnelles.html">
                                PHP_02_Les_instructions_conditionnelles
                            </a>
                            <a class="dropdown-item" href="PHP_03_Les_tableaux.html">
                                PHP_03_Les_tableaux
                            </a>
                            <a class="dropdown-item" href="PHP_04_Les_fonctions.html">
                                PHP_04_Les_fonctions
                            </a>
                            <a class="dropdown-item" href="PHP_05_Les_dates_et_les_heures.html">
                                PHP_05_Les_dates_et_les_heures
                            </a>
                            <a class="dropdown-item" href="PHP_06_Les_formulaires_et_les_variables_serveur.html">
                                PHP_06_Les_formulaires_et_les_variables_serveur
                            </a>
                            <a class="dropdown-item" href="PHP_07_La_manipulation_de_fichiers.html">
                                PHP_07_La_manipulation_de_fichiers
                            </a>
                            <a class="dropdown-item" href="PHP_08_Le_telechargement_de_fichiers.html">
                                PHP_08_Le_telechargement_de_fichiers
                            </a>
                            <a class="dropdown-item" href="PHP_09_Les_bibliotheques_de_fonctions.html">
                                PHP_09_Les_bibliotheques_de_fonctions
                            </a>
                            <a class="dropdown-item" href="PHP_10_PDO_Prise_en_main.html">
                                PHP_10_PDO_Prise_en_main
                            </a>
                            <a class="dropdown-item" href="PHP_11_PDO_CRUD_Create.html">
                                PHP_11_PDO_CRUD_Create
                            </a>
                            <a class="dropdown-item" href="PHP_12_PDO_CRUD_Read.html">
                                PHP_12_PDO_CRUD_Read
                            </a>
                            <a class="dropdown-item" href="PHP_13_PDO_CRUD_Update.html">
                                PHP_13_PDO_CRUD_Update
                            </a>
                            <a class="dropdown-item" href="PHP_14_PDO_CRUD_Delete.html">
                                PHP_14_PDO_CRUD_Delete
                            </a>
                            <a class="dropdown-item" href="PHP_15_Les_injections_SQL.html">
                                PHP_15_Les_injections_SQL
                            </a>
                            <a class="dropdown-item" href="PHP_16_PDO_Les_requetes_preparees.html">
                                PHP_16_PDO_Les_requêtes_préparées
                            </a>
                            <a class="dropdown-item" href="PHP_17_PDO_Synthese.html">
                                PHP_17_PDO_Synthese
                            </a>
                            <a class="dropdown-item" href="PHP_18_Les_sessions.html">
                                PHP_18_Les_sessions
                            </a>
                            <a class="dropdown-item" href="PHP_19_Authentification_et_mots_de_passe.html">
                                PHP_19_Authentification_et_mots_de_passe
                            </a>
                            <a class="dropdown-item" href="PHP_20_Les_mails.html">
                                PHP_20_Les_mails
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

  <main id="contenu" class="container" role="main">
    <article class="markdown-body">
<h1 id="1">PHP - Les injections SQL</h1>
            <div class="spacer" aria-hidden="true"></div>
            <h2 id="3">Quel est le problème ?</h2>
            <p>L'<em>injection SQL</em> est un type d'attaque qui consiste à tenter l'exécution de requêtes SQL non
                souhaitées :</p>
            <ul>
                <li>soit par saisie dans un champ de formulaire, </li>
                <li>soit par ajout de paramètres d'une url. </li>
            </ul>
            <div class="spacer" aria-hidden="true"></div>
            <p>Il s'agit d'une faille de sécurité spécifique au SQL, on la retrouve
                donc aussi bien dans MySQL, SQL Server etc. et quel que soit le langage côté serveur utilisé : PHP, Java, .Net... </p>
            <p>Les principaux risques sont : </p>
            <ul>
                <li>un accès non autorisé à des données ou à des pages en théorie protégées par session </li>
                <li>l'exécution d'actions non voulues sur la base (modification/suppression d'enregistrements, de
                    tables...)</li>
                <li>l'usurpation / élévation de droits</li>
            </ul>
            <div class="spacer" aria-hidden="true"></div>
            <h2 id="11">Exemple 1 : attaque d'un formulaire de connexion</h2>
            <p>L'attaque consiste à tenter de passer outre l'authentification sur un
                site, grâce à l'ajout de conditions de recherche sur un utilisateur en
                BDD.<br>
                Cela peut permettre de dévoiler en outre d'autres informations (voir
                tous les logins, et éventuellement les niveaux d'habilitation/rôles). </p>
            <p>Code HTML du formulaire :</p>
            <pre><code class="language-html hljs language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"login.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>                                           
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"login"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span> 
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"login"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"' or '1=1"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"password"</span>&gt;</span>Mot de passe<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"' or '1=1"</span>&gt;</span>                                  

    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Connexion"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>          </code></pre>
            <p>Code du fichier PHP de traitement :</p>
            <pre><code class="language-php hljs"><span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login='"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"login"</span>].<span class="hljs-string">"' AND password='"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"password"</span>].<span class="hljs-string">"'"</span>;

<span class="hljs-variable">$result</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);</code></pre>
<div class="callout callout-info" role="note" aria-label="Exemple sécurisé">
  <p><strong>Exemple sécurisé (PDO + requête préparée) :</strong></p>
<pre><code class="language-php hljs"> $sql = "SELECT * FROM users WHERE login = :login AND password = :password";
$stmt = $db-&gt;prepare($sql);
$stmt-&gt;execute([
  ':login' =&gt; $_POST['login'],
  ':password' =&gt; $_POST['password'],
]);
$user = $stmt-&gt;fetch(PDO::FETCH_OBJ);</code></pre>
  <p>On ne concatène plus les valeurs dans la chaîne SQL : PDO les transmet séparément au moteur, ce qui neutralise l'injection.</p>
</div>

            <div class="spacer" aria-hidden="true"></div>
            <p>La requête qui devrait <strong>normalement</strong> être exécutée est la suivante (les valeurs
                <em>Pierre</em> et <em>azerty1</em> sont dans la table <em>users</em>) :
            </p>
            <pre><code class="language-sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> login<span class="hljs-operator">=</span><span class="hljs-string">'Pierre'</span> <span class="hljs-keyword">AND</span> password<span class="hljs-operator">=</span><span class="hljs-string">'azerty1'</span>  </code></pre>
            <p>La requête <strong>réellement</strong> exécutée :</p>
            <pre><code class="language-sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> login<span class="hljs-operator">=</span><span class="hljs-string">''</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'1=1'</span> <span class="hljs-keyword">AND</span> password<span class="hljs-operator">=</span><span class="hljs-string">''</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'1=1'</span></code></pre>
            <p>Explications :</p>
            <ul>
                <li>Pour le champ login, le guillemet simple issu de la saisie vient fermer le
                    <code>WHERE login='</code>
                </li>
                <li>Ensuite <code>OR '1=1'</code> pose un <em>OU</em> , comme il n'y a pas de login avec une valeur vide
                    dans la base c'est la condition du <code>OR</code> qui s'applique et comme 1=1 est toujours vrai,
                    c'est ce résultat qui est considéré comme bon.</li>
                <li>Pour le login, on a le même mécanisme (puisqu'il a été saisi la même chose). </li>
            </ul>
<div class="callout callout-info" role="note" aria-label="Précision SQL">
  <p><strong>Précision :</strong> l'exemple illustre bien l'idée, mais en SQL réel, l'ordre de priorité des opérateurs (<code>AND</code> avant <code>OR</code>) peut changer le résultat si tu n'utilises pas de parenthèses. Les attaquants jouent aussi sur ces détails.</p>
</div>

            <div class="spacer" aria-hidden="true"></div>
            <p>Dans ce formulaire de connexion, la suite du script est bien sûr
                d'ouvrir une session considérant que le login/mot de passe est bon : </p>
<div class="callout callout-warn" role="note" aria-label="Authentification">
  <p><strong>Authentification :</strong> en vrai, on n'enregistre pas un mot de passe en clair. On stocke un <strong>hash</strong> (ex : <code>password_hash()</code>) et on vérifie avec <code>password_verify()</code>. Et on peut limiter la surface d'attaque en ne sélectionnant que les colonnes nécessaires.</p>
</div>

            <pre><code class="language-php hljs"><span class="hljs-variable">$user</span> = <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>(PDO::<span class="hljs-variable constant_">FETCH_OBJ</span>);

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$user</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$user</span>) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">"connected"</span>] = <span class="hljs-literal">TRUE</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">"connected"</span>] = <span class="hljs-literal">FALSE</span>;
}</code></pre>
            <p>Comme notre requête non sécurisée retourne bien un résultat, on se
                retrouve bien avec une session ouverte, malgré qu'aucun login ni mot de
                passe corrects n'aient été saisis ! </p>
            <blockquote>
                <p>Cet exemple va fonctionner selon l'écriture des guillemets (simples
                    ou doubles) ; mais les hackers vont, eux, essayer toutes les
                    combinaisons ! </p>
            </blockquote>
            <div class="spacer" aria-hidden="true"></div>
            <p>Ci-dessous, des exemples de syntaxes implémentant l'injection SQL :</p>
            <pre><code class="language-php hljs"><span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login='<span class="hljs-subst">$login</span>' AND password='<span class="hljs-subst">$password</span>'"</span>;
<span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login='"</span>.<span class="hljs-variable">$login</span>.<span class="hljs-string">"' AND password='"</span>.<span class="hljs-variable">$password</span>.<span class="hljs-string">"'"</span>; 
<span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login='"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"login"</span>].<span class="hljs-string">"' AND password='"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"password"</span>].<span class="hljs-string">"'"</span>; 
<span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login='<span class="hljs-subst">{$_POST["login"]}</span>' AND password='<span class="hljs-subst">{$_POST["password"]}</span>'"</span>;    </code></pre>
            <p>Et ci-dessous, un exemple souvent <strong>cru</strong> (à tort) « non injectable » parce qu'il utilise des guillemets doubles :</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$sql</span> = <span class="hljs-string">"SELECT * FROM users WHERE login=\""</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"login"</span>].<span class="hljs-string">"\" AND password=\""</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">"password"</span>].<span class="hljs-string">"\""</span>;</code></pre>
<div class="callout callout-danger" role="note" aria-label="Important">
  <p><strong>Important :</strong> utiliser des guillemets doubles (ou échapper des guillemets) <strong>ne supprime pas</strong> le risque d'injection SQL. Tant que tu concatènes une valeur contrôlable par l'utilisateur dans une requête, tu restes vulnérable (tautologies, <code>UNION</code>, etc.).</p>
  <p>La vraie parade consiste à utiliser des <strong>requêtes préparées</strong> (<code>prepare()</code> + <code>execute()</code>) et à valider/filtrer les entrées.</p>
</div>
            <div class="spacer" aria-hidden="true"></div>
            <h2 id="35">Exemple 2 : exécution d'une requête de suppression</h2>
            <p>L'injection SQL permet en théorie d'exécuter tout type de requête.</p>
            <p>On pourrait par exemple saisir ceci dans un champ de formulaire de connexion : </p>
            <pre><code class="hljs language-vbnet">Pierre<span class="hljs-comment">'; DELETE FROM users </span></code></pre>
            <p>Ce qui donnerait comme requête :</p>
            <pre><code class="language-sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> login<span class="hljs-operator">=</span><span class="hljs-string">'Pierre'</span>; <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> users;  </code></pre>
            <div class="spacer" aria-hidden="true"></div>
            <p>En PHP, les fonctions d'exécution de requêtes - <code>mysqli_query</code> ou, avec PDO,
                <code>-&gt;query</code> et <code>-&gt;exec()</code> bloquent désormais les requêtes multiples.
                Attention, ceci n'est peut-être pas le cas pour d'autres langages.
            </p>
            <div class="spacer" aria-hidden="true"></div>
            <h2 id="44">Parades</h2>
<div class="callout callout-warn" role="note" aria-label="Attention">
  <p><strong>Attention :</strong> <code>htmlspecialchars()</code> et <code>htmlentities()</code> protègent contre certaines attaques <strong>XSS</strong> (côté HTML). Elles <strong>ne protègent pas</strong> contre l'injection SQL. Pour SQL, la protection principale reste les <strong>requêtes préparées</strong>.</p>
</div>

            <ul>
                <li>En priorité, utiliser le connecteur PDO et, surtout des <strong>requêtes préparées</strong></li>
                <li>Echapper les caractères à risques, avec les fonctions PHP <a
                        href="http://php.net/manual/fr/function.htmlspecialchars.php"
                        target="_blank"><code>htmlspecialchars()</code></a> ou <a
                        href="http://php.net/manual/fr/function.htmlentities.php"
                        target="_blank"><code>htmlentities()</code></a>, qui transforment les caractères spéciaux en
                    entités HTML (cf. la faille XSS)</li>
                <li>Bien filtrer les données saisies dans un formulaire ou transmises par les urls : <strong>ne jamais
                        faire confiance à l'utilisateur</strong> !</li>
                <li>Spécifier des droits et des rôles utilisateur sur les bases de données. </li>
            </ul>
            <div class="spacer" aria-hidden="true"></div>
            <h2 id="47">Ressources complémentaires</h2>
            <p>D'autres exemples d'injection SQL en PHP :</p>
            <ul>
                <li><a href="http://php.net/manual/fr/security.database.sql-injection.php" target="_blank">Exemple 1</a>
                </li>
                <li><a href="https://www.phpsecure.info/v2/article/InjSql.php" target="_blank">Exemple 2</a></li>
            </ul>
            <div class="spacer" aria-hidden="true"></div>
    </article>
  </main>

  <script>
    if (window.hljs && typeof window.hljs.highlightAll === "function") {
      window.hljs.highlightAll();
    }
    (function () {
      const h1 = document.querySelector("main h1");
      if (h1 && h1.textContent) document.title = h1.textContent.trim();
    })();
  </script>
</body>
</html>
